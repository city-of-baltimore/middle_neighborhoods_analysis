---
title: ""
author: "Justin Elszasz, Mayor's Office of Innovation"
email: "justin.elszasz@baltimorecity.gov"
date: "Tuesday, February 12, 2019"
output:
  html_notebook:
    code_folding: hide
    fig_height: 5
    fig_width: 10
    toc: yes
    toc_depth: 2
---

```{r setup, include = FALSE, echo = FALSE, message = FALSE, cache = TRUE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = F, 
                      message = F, 
                      include = T,
                      fig.width = 10,
                      fig.height = 5)
``` 



```{r}
source("../src/00_initialize.R")
library(RSocrata)
library(scales)
library(lubridate)
library(leaflet)
```


```{r}
hmt <- load_block_group_data(load.cache = T)
hoods <- get_neighborhood_boundaries()
cfs.narc <- read.socrata("https://data.baltimorecity.gov/resource/m8g9-abgb.json?description=NARCOTICSOutside")
#crime <- read.socrata("https://data.baltimorecity.gov/resource/4ih5-d5d5.json")
```

```{r}
cfs.narc <- cfs.narc %>% 
  unlist_lat_long("location.coordinates")

cfs.narc.geo <- cfs.narc %>% filter(!is.na(long))
  
cfs.narc.geo <- SpatialPointsDataFrame(
  cfs.narc.geo %>% select(long, lat), cfs.narc.geo,
  proj4string = CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"))

cfs.narc.geo <- spTransform(cfs.narc.geo, CRSobj = CRS("+init=epsg:4326 +proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"))
```


```{r}
cfs.narc %>% glimpse
```

```{r}
cfs.narc %>% 
  count(!is.na(long)) %>% 
  mutate(pct = percent(n / sum(n))) 
```
```{r}
cfs.narc %>%
  mutate(call.ym = floor_date(calldatetime, "month")) %>%
  filter(call.ym < "2019-01-01") %>%
  count(call.ym) %>%
  ggplot(aes(call.ym, n)) +
  geom_line() +
  theme_iteam_google_docs()
```

```{r}
cfs.narc %>%
  count(year(calldatetime))
```




```{r}
set.seed(1)

map.points <- cfs.narc.geo[sample(1:length(cfs.narc.geo), 50000), ]

leaflet() %>%
  setView(lng = -76.6, lat = 39.3, zoom = 11) %>%
  addProviderTiles(providers$Stamen.TonerLite) %>%
  addPolygons(data = hmt,
              fillOpacity = 0,
              color = iteam.colors[2],
              opacity = 0.7,
              weight = 1) %>%
  addCircleMarkers(data = map.points, radius = 1, color = iteam.colors[5])

```

```{r}
cfs.narc.hmt <- over(cfs.narc.geo, hmt)

cfs.narc.geo@data <- bind_cols(cfs.narc.geo@data, cfs.narc.hmt)
```

```{r}
map.points <- cfs.narc.geo[sample(1:length(cfs.narc.geo), 10000), ]


pal <- colorFactor(
  domain = map.points$MVA17HrdCd,
  palette = topo.colors(15)
)


leaflet() %>%
  setView(lng = -76.6, lat = 39.3, zoom = 11) %>%
  addProviderTiles(providers$Stamen.TonerLite) %>%
  addPolygons(data = hmt,
              fillOpacity = 0,
              color = iteam.colors[2],
              opacity = 0.7,
              weight = 1) %>%
  addCircleMarkers(data = map.points, radius = 1, color = ~pal(map.points$MVA17HrdCd))

```

```{r}
tier.pop <- hmt@data %>% group_by(hmt.tier) %>% summarise(tier.pop = sum(Population.2016))

cfs.narc.geo@data %>%
  mutate(call.year = year(calldatetime)) %>%
  filter(call.year != 2019, !is.na(hmt.tier)) %>%
  count(hmt.tier) %>%
  left_join(tier.pop, by = "hmt.tier") %>%
  ungroup() %>% 
  mutate(annual.narc.call.per1000 = round(1000 * n / tier.pop / 4, 1),
         pct.pop = percent(tier.pop / sum(tier.pop, na.rm = T)),
         pct.calls = percent(n / sum(n))) %>%
  arrange(desc(annual.narc.call.per1000))
```

```{r}
cfs.narc.ratios.by.year <- cfs.narc.geo@data %>%
  mutate(call.year = year(calldatetime)) %>%
  filter(call.year != 2019,
         !is.na(hmt.tier)) %>%
  count(hmt.tier, call.year) %>%
  left_join(tier.pop, by = "hmt.tier") %>%
  mutate(narc.call.ratio = round(1000 *n / tier.pop, 1)) %>%
  ungroup() %>%
  group_by(call.year) %>%
  arrange(hmt.tier) %>%
  ungroup() %>%
  group_by(hmt.tier) %>%
  mutate(narc.call.ratio.pct.chg = narc.call.ratio / first(narc.call.ratio) - 1)

cfs.narc.ratios.by.year
```


```{r fig.width = 7, fig.height = 4}
cfs.narc.ratios.by.year %>%
  filter(hmt.tier != "other") %>%
  ggplot(aes(call.year, narc.call.ratio.pct.chg, color = hmt.tier)) +
  geom_line(size = 0.75) +
  theme_iteam_google_docs() +
  theme(axis.title.x = element_blank()) +
  scale_y_continuous(labels = scales::percent, limits = c(-.5, .5)) +
  labs(title = "Changes in Narcotics 911 CFS by Housing Typology Tier\n2015 Base Year",
       y = "% Change in Narcotics Calls Ratio from 2015") 
  
```

```{r echo = F}
cfs.narc.bg <- over(cfs.narc.geo, hmt)

cfs.narc.geo@data <- bind_cols(cfs.narc.geo@data, cfs.narc.bg)

cfs.narc.bg.counts <- as.data.frame(table(cfs.narc.bg$bg))

hmt@data <- left_join(hmt@data, cfs.narc.bg.counts, by = c("bg" = "Var1")) 
  
hmt@data <- hmt@data %>%
  rename(cfs.narc.count = Freq) %>%
  mutate(cfs.narc.ratio = 1000 * cfs.narc.count / Population.2016)
```

```{r}
hmt@data %>%
  ggplot(aes(cfs.narc.ratio)) +
  geom_histogram() +
  theme_iteam_google_docs() +
  xlim(c(-50, 1000))
```


```{r echo = F}
bins <- c(0, 50, 100, 200, 300, 400, 500, 750, 1000, 1500, Inf)
pal <- colorBin("YlOrRd", domain = hmt$cfs.narc.ratio, bins = bins)

leaflet() %>%
  setView(lng = -76.6, lat = 39.3, zoom = 11) %>%
  addProviderTiles(providers$Stamen.TonerLite) %>% 
  addPolygons(data = hmt, 
              fillColor = ~pal(hmt$cfs.narc.ratio), 
              color = iteam.colors[2], 
              weight = 1, 
              fillOpacity = .6,
              label = ~as.character(round(hmt$cfs.narc.ratio, 0 ))) %>%
  addPolygons(data = hoods, 
              weight = 2, 
              color = "black",
              opacity = 0.5,
              fillOpacity = 0, 
              label = ~hoods$label)

```



```{r echo = F}
bins <- c(0, 50, 100, 200, 300, 400, 500, 750, 1000, 1500, Inf)
pal <- colorBin("YlOrRd", domain = hmt$cfs.narc.ratio, bins = bins)

leaflet() %>%
  setView(lng = -76.6, lat = 39.3, zoom = 11) %>%
  addProviderTiles(providers$Stamen.TonerLite) %>% 
  addPolygons(data = hmt, 
              fillColor = ~pal(hmt$cfs.narc.ratio), 
              color = iteam.colors[2], 
              weight = 1, 
              fillOpacity = .6,
              label = ~as.character(round(hmt$cfs.narc.ratio, 0 ))) %>%
  addPolygons(data = hoods, 
              weight = 2, 
              color = "black",
              opacity = 0.5,
              fillOpacity = 0, 
              label = ~hoods$label)

```