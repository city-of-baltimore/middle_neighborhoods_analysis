---
title: "Intro to Middle Neighborhoods"
subtitle: "Neighborhoods Subcabinet Middle Neighborhood Working Group"
author: "Justin Elszasz, Mayor's Office of Innovation"
email: "justin.elszasz@baltimorecity.gov"
date: "Friday, February 22, 2019"
css: iteam_pres.css
font-import: http://fonts.googleapis.com/css?family=Lato
font-family: 'Oswald'
output: 
  slidy_presentation:
    highlight: pygments
    md_extensions: +raw_html
    toc: yes
    footer: "Mayor's Office of Innovation"
---

```{r setup, include = FALSE, echo = FALSE, message = FALSE, cache = TRUE}
knitr::opts_chunk$set(echo = F, warning = F, message = F, include = T,
                      fig.width = 8, fig.height = 5)

``` 

```{r init, include = F, echo = F, cache = T}
source("../src/00_initialize.R")

library(leaflet)
library(knitr)
library(kableExtra)
```

```{r get.data, cache = T, echo = F, include = F}
hmt <- load_block_group_data(load.cache = T)
hoods <- get_neighborhood_boundaries()
#sr <- get_2018_service_requests_from_ob()
sr <- load_2018_service_requests(load.cache = T)
#sr <- spTransform(sr, CRS("+init=epsg:4326"))

```

```{r include = F}
# HUD area median income for Baltimore-Columbia-Towson
ami.2016 <- 86700
#ami.2018 <- 94900
```


# Our Middle Neighborhoods (based on HMT)

```{r echo = F, message = F, out.width="100%"}
mid.hoods.hmt <- subset(hmt, hmt.tier %in% c("lower middle", "upper middle"))

hmt.pal <- colorFactor(
  domain = hmt$hmt.tier,
  palette = c("gray65",
              "gray85",
              "#f0c650", 
              "white",
              iteam.colors[1])
)

leaflet() %>% 
  setView(lng = -76.6, lat = 39.3, zoom = 11) %>%
  addProviderTiles(providers$Stamen.TonerLite) %>%
  addPolygons(data = hmt, 
              color = iteam.colors[2],
              weight = 1,
              fillColor = ~hmt.pal(hmt.tier),
              #fillColor = iteam.colors[1],
              fillOpacity = .6,
              opacity = .7,
              label = ~as.character(hmt$MVA17HrdCd)
              ) %>%
  #addGeoJSON(hoods, weight = 1, color = "black", fillOpacity = 0)
  addPolygons(data = hoods, 
              weight = 2, 
              color = "black",
              opacity = 0.5,
              fillOpacity = 0, 
              label = ~hoods$label) %>%
  addLegend(data = hmt,
            position = "bottomright",
            pal = hmt.pal,
            values = ~hmt$hmt.tier, 
            title = "HMT Tier")
```

# Our middle neighborhoods (median household income 75%-125% of city median income)

```{r include = F}
# HUD area median income for Baltimore-Columbia-Towson
#ami.2016 <- 86700
#ami.2018 <- 94900

hmt@data <- hmt@data %>% mutate(
    # assign healthy, middle, and distressed based on block group median income
    med.inc.tier = 
    case_when(
      (hmt.tier != "other") & 
        (Median_Household_Income.2016 > 1.25 * City_Median_Household_Income.2016) ~ "healthy",
      (hmt.tier != "other") & 
        (Median_Household_Income.2016 < 0.75 * City_Median_Household_Income.2016) ~ "distressed",
      (hmt.tier == "other") ~ NA_character_,
      TRUE ~ "middle"
    ),
    affordability.tier = case_when(
      (hmt.tier != "other") & 
        (MSP1517eo <= 3 * 1.25 * City_Median_Household_Income.2016) &
        (MSP1517eo >= 3 * 0.75 * City_Median_Household_Income.2016) ~ "middle",
      hmt.tier == "other" ~ NA_character_,
      TRUE ~ "not middle"
      
    )
  )
```


```{r echo = F, out.width="100%"}
mid.hoods.med.inc <- subset(hmt, med.inc.tier == "middle")

leaflet() %>% 
  setView(lng = -76.6, lat = 39.3, zoom = 11) %>%
  addProviderTiles(providers$Stamen.TonerLite) %>%
  addPolygons(data = mid.hoods.med.inc, 
              color = iteam.colors[3],
              weight = 1,
              #fillColor = ~pal(MVA17HrdCd),
              fillColor = iteam.colors[3],
              fillOpacity = .6,
              #opacity = 0,
              label = ~as.character(mid.hoods.med.inc$MVA17HrdCd)
              ) %>%
  #addGeoJSON(hoods, weight = 1, color = "black", fillOpacity = 0)
  addPolygons(data = hoods, 
              weight = 2, 
              color = "black",
              opacity = 0.5,
              fillOpacity = 0, 
              label = ~hoods$label) %>%
    addLegend(data = hmt,
            position = "bottomright",
            colors =  c(iteam.colors[3]),
            labels = "Middle (based on 25% - 75% City Median Income)",
            title = "")
```

# Our middle neighborhoods (where middle income-earners could afford to live)


```{r echo = F, out.width="100%"}
mid.hoods.affordability <- subset(hmt, affordability.tier == "middle")

leaflet() %>% 
  setView(lng = -76.6, lat = 39.3, zoom = 11) %>%
  addProviderTiles(providers$Stamen.TonerLite) %>%
  addPolygons(data = mid.hoods.affordability, 
              color = iteam.colors[3],
              weight = 1,
              #fillColor = ~pal(MVA17HrdCd),
              fillColor = iteam.colors[4],
              fillOpacity = .6,
              #opacity = 0,
              label = ~as.character(mid.hoods.affordability$MVA17HrdCd)
              ) %>%
  #addGeoJSON(hoods, weight = 1, color = "black", fillOpacity = 0)
  addPolygons(data = hoods, 
              weight = 2, 
              color = "black",
              opacity = 0.5,
              fillOpacity = 0, 
              label = ~hoods$label) %>%
    addLegend(data = hmt,
            position = "bottomright",
            colors =  c(iteam.colors[4]),
            labels = "Middle (based on affordability)",
            title = "")
```

# Comparing the definitions

```{r echo = F, out.width = "100%"}
leaflet() %>% 
  setView(lng = -76.6, lat = 39.3, zoom = 11) %>%
  addProviderTiles(providers$Stamen.TonerLite) %>%
  addPolygons(data = mid.hoods.affordability, 
              color = iteam.colors[3],
              weight = 1,
              #fillColor = ~pal(MVA17HrdCd),
              fillColor = iteam.colors[4],
              fillOpacity = .6,
              #opacity = 0,
              label = ~as.character(mid.hoods.affordability$MVA17HrdCd)
  ) %>%
  addPolygons(data = mid.hoods.med.inc, 
              color = iteam.colors[3],
              weight = 1,
              #fillColor = ~pal(MVA17HrdCd),
              fillColor = iteam.colors[3],
              fillOpacity = .7,
              #opacity = 0,
              label = ~as.character(mid.hoods.med.inc$MVA17HrdCd)) %>%
  addPolygons(data = mid.hoods.hmt, 
              color = iteam.colors[1],
              weight = 1,
              #fillColor = ~pal(MVA17HrdCd),
              fillColor = iteam.colors[1],
              fillOpacity = .5,
              #opacity = 0,
              label = ~as.character(mid.hoods.hmt$MVA17HrdCd)) %>%
  addPolygons(data = hoods, 
              weight = 2, 
              color = "black",
              opacity = 0.5,
              fillOpacity = 0, 
              label = ~hoods$label) %>%
  addLegend("bottomright",
            colors = c(iteam.colors[1], iteam.colors[3], iteam.colors[4]),
            labels = c("HMT definition", "Median income definition", "Affordability definition"))
```


# Comparing the definitions

```{r echo = F, out.width="100%"}
hmt.summary <- hmt@data %>% 
  mutate(hmt.tier = ifelse(hmt.tier %in% c("lower middle", "upper middle"), "middle", hmt.tier)) %>%
  group_by(hmt.tier) %>%
  summarise(n.block.groups.hmt = n(),
            pop.hmt = sum(Population.2016)) %>%
  mutate(pct.block.groups.hmt = percent(n.block.groups.hmt / sum(n.block.groups.hmt)),
         pct.pop.hmt = percent(pop.hmt / sum(pop.hmt)))

med.inc.summmary <- hmt@data %>% 
  group_by(med.inc.tier) %>%
  summarise(n.block.groups.med.inc = n(),
            pop.med.inc = sum(Population.2016)) %>%
  mutate(pct.block.groups.med.inc = percent(n.block.groups.med.inc / sum(n.block.groups.med.inc)),
         pct.pop.med.inc = percent(pop.med.inc / sum(pop.med.inc)))

affordability.summmary <- hmt@data %>% 
  group_by(affordability.tier) %>%
  summarise(n.block.groups.affordability = n(),
            pop.affordability = sum(Population.2016)) %>%
  mutate(pct.block.groups.affordability = percent(n.block.groups.affordability / sum(n.block.groups.affordability)),
         pct.pop.affordability = percent(pop.affordability / sum(pop.affordability)))

left_join(hmt.summary, med.inc.summmary, by = c("hmt.tier" = "med.inc.tier")) %>%
  left_join(affordability.summmary, by = c("hmt.tier" = "affordability.tier")) %>%
  rename(tier = "hmt.tier") %>%
  filter(tier != "other") %>%
  transmute(Tier = tier,
            `Population (HMT)` = pop.hmt,
            `% City Pop (HMT)` = pct.pop.hmt,
            `Population (Median Income)` = pop.med.inc,
            `% City Pop (Median Income)` = pct.pop.med.inc,
            `Population (Affordability)` = pop.affordability,
            `% City Pop (Affordability)` = pct.pop.affordability) %>%
  kable() %>%
  column_spec(c(1:7), width = "10em")
```

# Healthy block groups and lower middle block groups are similar in terms of percent owner-occupied 

<div align = "center" style="float: center; width: 60%;">

```{r echo = F, out.width="100%"}
hmt@data %>%
  filter(hmt.tier != "other") %>%
  mutate(pct.nonwhite = AfricanAmerican.2016) %>%
  # filter(!is.na(Median_Household_Income.2016),
  #        Median_Household_Income.2016 > 0,
  #        hmt.tier %in% c("lower middle", "upper middle")) %>% 
  ggplot(aes(Percent_Owner.2016)) +
  geom_freqpoly(aes(color = hmt.tier), stat = "density") +
  theme_iteam_presentations() +
  scale_x_continuous(labels = scales::percent, limits = c(-.1, 1.1)) +
  labs(
    title = paste0("Middle Neighborhood\nBlock Group % Owner-Occupied\n",
                   "Distribution by HMT Market tier"),
    subtitle = "",
    x = "% Owner-Occupied",
    y = "Density",
    caption = paste0("tier based on 2017 HMT analysis; ",
                     "median household incomes from 2012-2016 ACS data.")
  ) +
  theme(plot.caption = element_text(hjust = 1, face = "plain"),
        legend.title = element_blank())
```

</div>

# Neighborhood typologies are strongly correlated with race

<div align = "center" style="float: center; width: 60%;">

```{r echo = F, out.width="100%"}
hmt@data %>%
  filter(hmt.tier != "other") %>%
  mutate(pct.nonwhite = AfricanAmerican.2016) %>%
  # filter(!is.na(Median_Household_Income.2016),
  #        Median_Household_Income.2016 > 0,
  #        hmt.tier %in% c("lower middle", "upper middle")) %>% 
  ggplot(aes(pct.nonwhite)) +
  geom_freqpoly(aes(color = hmt.tier), stat = "density") +
  theme_iteam_presentations() +
  scale_x_continuous(labels = scales::percent, limits = c(-.1, 1.1)) +
  labs(
    title = paste0("Middle Neighborhood\nBlock Group % African-American\n",
                   "Distribution by HMT Market tier"),
    subtitle = "",
    x = "% African-American",
    y = "Density",
    caption = paste0("tier based on 2017 HMT analysis; ",
                     "median household incomes from 2012-2016 ACS data.")
  ) +
  theme(plot.caption = element_text(hjust = 1, face = "plain"),
        legend.title = element_blank())
```
</div>

# Income levels in our middle neighborhoods are well below area's

<div align = "center" style="float: center; width: 60%;">

```{r echo = F, out.width="100%"}
hmt@data %>% 
  filter(!is.na(Median_Household_Income.2016),
         Median_Household_Income.2016 > 0,
         hmt.tier %in% c("lower middle", "upper middle")) %>% 
  ggplot(aes(Median_Household_Income.2016)) +
  geom_freqpoly(aes(color = hmt.tier), stat = "density") +
  theme_iteam_presentations() +
  labs(
    title = paste0("Middle Neighborhood\nBlock Group Median Household Income\n",
                   "Distribution by HMT Market tier"),
    subtitle = "",
    x = "Median Household Income",
    y = "Count",
    caption = paste0("tier based on 2017 HMT analysis; ",
                     "median household incomes from 2012-2016 ACS data.")
  ) +
  geom_vline(aes(xintercept = ami.2016), color = iteam.colors[2]) +
  annotate("text", x = ami.2016 - 2500, y = .000025,
           label = paste0("Baltimore-Columbia-Towson 2016 AMI:\n", dollar(ami.2016)),
           hjust = 1) +
  theme(plot.caption = element_text(hjust = 1, face = "plain"),
        legend.title = element_blank())
```
</div>

# Middle neighborhoods have more older homeowners

<div align = "left" style="float: left; width: 40%;">

```{r echo = F}
hmt@data %>%
  filter(hmt.tier != "other") %>%
  group_by(hmt.tier) %>%
  summarise(mean.pct.ho.over65 = percent(mean(Percent_Homeowner_Over_65.2016)),
            med.pct.ho.over65 = percent(median(Percent_Homeowner_Over_65.2016))) %>%
  rename("Mean % Homeowners 65+" = mean.pct.ho.over65,
         "Median % Homeowners 65+" = med.pct.ho.over65) %>%
  kable() %>%
  column_spec(c(1,2,3), width = "20em")
```
</div>

<div align = "right" style="float: right; width: 60%;">

```{r echo = F, out.width="100%"}
hmt@data %>% 
  filter(hmt.tier != "other") %>% 
  ggplot(aes(Percent_Homeowner_Over_65.2016)) +
  geom_freqpoly(aes(color = hmt.tier), stat = "density") +
  theme_iteam_presentations() +
  labs(
    title = "% Homeowners 65+ by HMT Market tier",
    subtitle = "",
    x = "% Homeowners 65+ y.o.",
    y = "Density",
    caption = paste0("tier based on 2017 HMT analysis; ",
                     "% homeowners 65 and over from 2012-2016 ACS data.")
  ) +
  theme(plot.caption = element_text(hjust = 1, face = "plain"),
        legend.title = element_blank()) +
  scale_x_continuous(labels = percent)
```

</div>

```{r echo = F, include = F}
sr.norats <- subset(sr, srtype != "SW-Rat Rubout Proactive")

all.sr.bg <- over(sr.norats, hmt)

sr.norats@data <- bind_cols(sr.norats@data, all.sr.bg)

all.sr.bg.counts <- as.data.frame(table(all.sr.bg$bg))

hmt@data <- left_join(hmt@data, all.sr.bg.counts, by = c("bg" = "Var1")) 
  
hmt@data <- hmt@data %>%
  rename(all.sr.count = Freq) %>%
  mutate(sr.ratio = 1000 * all.sr.count / Population.2016)
```



# Total Service Requests per 1,000 Residents

<div align = "right" style="float: right;">

```{r echo = F, fig.width = 5}
bins <- c(0, 250, 500, 750, 1000, 1500, 2000, Inf)
pal <- colorBin("YlOrRd", domain = hmt$sr.ratio, bins = bins)

leaflet() %>%
  setView(lng = -76.6, lat = 39.3, zoom = 11) %>%
  addProviderTiles(providers$Stamen.TonerLite) %>% 
  addPolygons(data = subset(hmt, hmt$sr.ratio <= 3000), 
              fillColor = ~pal(hmt$sr.ratio), 
              color = iteam.colors[2], 
              weight = 1, 
              fillOpacity = 1,
              label = ~as.character(round(hmt$sr.ratio, 0 ))) %>%
  addPolygons(data = hoods, 
              weight = 2, 
              color = "black",
              opacity = 0.5,
              fillOpacity = 0, 
              label = ~hoods$label)
```

</div>

<div align = "left" style="float: left; width: 40%;">

```{r echo = F}
sr.by.hmt.tier <- hmt@data %>%
  group_by(hmt.tier) %>%
  summarise(total.pop = sum(Population.2016),
            sr.count = sum(all.sr.count),
            sr.ratio = round(1000 * sr.count / total.pop, 0)) %>%
  arrange(desc(sr.ratio))

sr.by.hmt.tier %>% 
  rename("Population" = total.pop,
         "SR Count" = sr.count,
         "SR's per 1,000 Residents" = sr.ratio,
         "HMT Tier" = hmt.tier) %>% 
  kable() %>%
  column_spec(4, width = "10em")
```
</div>

```{r echo = F, include = F}
hmt@data %>%
  ggplot(aes(sr.ratio)) +
  geom_histogram() +
  xlim(c(0, 2500)) +
  theme_iteam_google_docs()
```


# Top Service Request Types by HMT Tier

```{r echo = F, warning = F, include = F}
sr.norats@data %>% 
  filter(!is.na(hmt.tier)) %>%
  count(hmt.tier, srtype) %>% 
  mutate(hmt.tier = as.factor(hmt.tier),
         srtype = as.factor(srtype)) %>%
  left_join(sr.by.hmt.tier %>% select(hmt.tier, total.pop), by = "hmt.tier") %>%
  mutate(sr.ratio = round(1000 * n / total.pop, 1)) %>%
  arrange(hmt.tier, desc(sr.ratio)) %>%
  group_by(hmt.tier) %>%
  filter(row_number() %in% c(1)) %>%
  kable()
```

```{r echo = F, warning = F, out.width="100%"}
sr.norats@data %>% 
  filter(!is.na(hmt.tier)) %>%
  count(hmt.tier, srtype) %>% 
  mutate(hmt.tier = as.factor(hmt.tier),
         srtype = as.factor(srtype)) %>%
  left_join(sr.by.hmt.tier %>% select(hmt.tier, total.pop), by = "hmt.tier") %>%
  mutate(sr.ratio = round(1000 * n / total.pop, 1)) %>%
  #filter(!is.na(sr.ratio)) %>%
  arrange(hmt.tier, desc(sr.ratio)) %>%
  group_by(hmt.tier) %>%
  mutate(rank = row_number())  %>%
  filter(rank %in% c(1, 2, 3, 4, 5)) %>% 
  select(-n, -total.pop, -sr.ratio) %>%
  spread(key = hmt.tier, value = srtype) %>%
  select(rank, healthy, `upper middle`, `lower middle`, distressed, other) %>%
  kable() %>%
  column_spec(column = c(3, 4), width = "10em")
  
  
```

# The upper middle neighborhood tier has gone through a larger swing in narcotics 911 calls

```{r narc, cache = T, include = F}
library(RSocrata)
library(lubridate)
cfs.narc <- read.socrata("https://data.baltimorecity.gov/resource/m8g9-abgb.json?description=NARCOTICSOutside")

cfs.narc <- cfs.narc %>% 
  unlist_lat_long("location.coordinates")

cfs.narc.geo <- cfs.narc %>% filter(!is.na(long))
  
cfs.narc.geo <- SpatialPointsDataFrame(
  cfs.narc.geo %>% select(long, lat), cfs.narc.geo,
  proj4string = CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"))

cfs.narc.geo <- spTransform(cfs.narc.geo, CRSobj = CRS("+init=epsg:4326 +proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"))
```

```{r include = F}
cfs.narc.hmt <- over(cfs.narc.geo, hmt)

cfs.narc.geo@data <- bind_cols(cfs.narc.geo@data, cfs.narc.hmt)
```

```{r include = F}
cfs.narc.bg <- over(cfs.narc.geo, hmt)

cfs.narc.geo@data <- bind_cols(cfs.narc.geo@data, cfs.narc.bg)

cfs.narc.bg.counts <- as.data.frame(table(cfs.narc.bg$bg))

hmt@data <- left_join(hmt@data, cfs.narc.bg.counts, by = c("bg" = "Var1")) 
  
hmt@data <- hmt@data %>%
  rename(cfs.narc.count = Freq) %>%
  mutate(cfs.narc.ratio = 1000 * cfs.narc.count / Population.2016)
```

<div align = "left" style="float: left; width: 40%;">

```{r echo = F, out.width = "100%"}
tier.pop <- hmt@data %>% group_by(hmt.tier) %>% summarise(tier.pop = sum(Population.2016))

cfs.narc.geo@data %>%
  mutate(call.year = year(calldatetime)) %>%
  filter(call.year != 2019, !is.na(hmt.tier)) %>%
  count(hmt.tier) %>%
  left_join(tier.pop, by = "hmt.tier") %>%
  ungroup() %>% 
  mutate(annual.narc.call.per1000 = round(1000 * n / tier.pop / 4, 1),
         pct.pop = percent(tier.pop / sum(tier.pop, na.rm = T)),
         pct.calls = percent(n / sum(n))) %>%
  arrange(desc(annual.narc.call.per1000)) %>%
  transmute(Tier = hmt.tier,
            Calls = n,
            Population = tier.pop,
            `Annual Narc CFS per 1,000 Residents` = annual.narc.call.per1000,
            `% City Population` = pct.pop,
            `% Narc CFS` = pct.calls
            ) %>%
  kable() %>%
  column_spec(column = c(1,2,3,4,5,6), width = "10em")
```

```{r include = F}
cfs.narc.ratios.by.year <- cfs.narc.geo@data %>%
  mutate(call.year = year(calldatetime)) %>%
  filter(call.year != 2019,
         !is.na(hmt.tier)) %>%
  count(hmt.tier, call.year) %>%
  left_join(tier.pop, by = "hmt.tier") %>%
  mutate(narc.call.ratio = round(1000 *n / tier.pop, 1)) %>%
  ungroup() %>%
  group_by(call.year) %>%
  arrange(hmt.tier) %>%
  ungroup() %>%
  group_by(hmt.tier) %>%
  mutate(narc.call.ratio.pct.chg = narc.call.ratio / first(narc.call.ratio) - 1)

cfs.narc.ratios.by.year
```
</div>

<div align = "right" style="float: right; width: 50%;">

```{r echo = F, out.width = "100%", height = 4}
cfs.narc.ratios.by.year %>%
  filter(hmt.tier != "other") %>%
  ggplot(aes(call.year, narc.call.ratio.pct.chg, color = hmt.tier)) +
  geom_line(size = 0.75) +
  theme_iteam_presentations() +
  theme(axis.title.x = element_blank(),
        legend.title = element_blank()) +
  scale_y_continuous(labels = scales::percent, limits = c(-.5, .5)) +
  labs(title = "Changes in Narcotics 911 CFS\nby Housing Typology Tier\n2015 Base Year",
       y = "% Change in Narcotics Calls Ratio from 2015") 
```
</div>

# Narcotics 911 calls point to some hotspots in middle neighborhoods

```{r echo = F, out.width = "100%", warning = F}
bins <- c(0, 50, 100, 200, 300, 400, 500, 750, 1000, 1500, Inf)
pal <- colorBin("YlOrRd", domain = hmt$cfs.narc.ratio, bins = bins)

leaflet() %>%
  setView(lng = -76.6, lat = 39.3, zoom = 11) %>%
  addProviderTiles(providers$Stamen.TonerLite) %>% 
  addPolygons(data = hmt, 
              fillColor = ~pal(hmt$cfs.narc.ratio), 
              color = iteam.colors[2], 
              weight = 1, 
              fillOpacity = .6) %>%
  addPolygons(data = hoods, 
              weight = 2, 
              color = "black",
              opacity = 0.5,
              fillOpacity = 0, 
              label = ~hoods$label)

```
