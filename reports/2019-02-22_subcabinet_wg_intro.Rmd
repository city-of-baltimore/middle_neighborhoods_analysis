---
title: "Intro to Middle Neighborhoods"
author: "Justin Elszasz, Mayor's Office of Innovation"
email: "justin.elszasz@baltimorecity.gov"
date: "Friday, February 22, 2019"
css: iteam_pres.css
output: 
  slidy_presentation:
    toc: true
---

```{r setup, include = FALSE, echo = FALSE, message = FALSE, cache = TRUE}
knitr::opts_chunk$set(echo = F, warning = F, message = F, include = T,
                      fig.width = 10, fig.height = 5)

``` 

```{r init, include = F}
source("../src/00_initialize.R")

library(leaflet)
library(knitr)
```

```{r get.data, cache = F, echo = F}
hmt <- load_block_group_data(load.cache = T)
hoods <- get_neighborhood_boundaries()
#sr <- get_2018_service_requests_from_ob()
sr <- load_2018_service_requests(load.cache = T)
#sr <- spTransform(sr, CRS("+init=epsg:4326"))

```

```{r include = F}
# HUD area median income for Baltimore-Columbia-Towson
ami.2016 <- 86700
#ami.2018 <- 94900
```


# Housing Market Typology 

- Performed every few years by Reinvestment Fund
- Uses 8 variables


# The Housing Market Typologies

# Our Middle Neighborhoods

Breaking "middle" into "lower middle" (F, G, H) and "upper middle" (D, E) and including "healthy" and "distressed:

```{r echo = F}
#mid.hoods.hmt <- subset(hmt, hmt.tier %in% c("lower middle", "upper middle"))

hmt.pal <- colorFactor(
  domain = hmt$hmt.tier,
  palette = c("gray65",
              "gray85",
              "#f0c650", 
              NA,
              iteam.colors[1])
)

leaflet() %>% 
  setView(lng = -76.6, lat = 39.3, zoom = 11) %>%
  addProviderTiles(providers$Stamen.TonerLite) %>%
  addPolygons(data = hmt, 
              color = iteam.colors[2],
              weight = 1,
              fillColor = ~hmt.pal(hmt.tier),
              #fillColor = iteam.colors[1],
              fillOpacity = .6,
              opacity = .7,
              label = ~as.character(hmt$MVA17HrdCd)
              ) %>%
  #addGeoJSON(hoods, weight = 1, color = "black", fillOpacity = 0)
  addPolygons(data = hoods, 
              weight = 2, 
              color = "black",
              opacity = 0.5,
              fillOpacity = 0, 
              label = ~hoods$label)
```

# Income levels in our middle neighborhoods are well below area's


```{r echo = F}
hmt@data %>% 
  filter(!is.na(Median_Household_Income.2016),
         Median_Household_Income.2016 > 0,
         hmt.tier %in% c("lower middle", "upper middle")) %>% 
  ggplot(aes(Median_Household_Income.2016)) +
  geom_freqpoly(aes(color = hmt.tier), bins = 50) +
  theme_iteam_presentations() +
  labs(
    title = paste0("Middle Neighborhood\nBlock Group Median Household Income\n",
                   "Distribution by HMT Market tier"),
    subtitle = "",
    x = "Median Household Income",
    y = "Count",
    caption = paste0("tier based on 2017 HMT analysis; ",
                     "median household incomes from 2012-2016 ACS data.")
  ) +
  geom_vline(aes(xintercept = ami.2016), color = iteam.colors[2]) +
  annotate("text", x = ami.2016 - 2500, y = 12,
           label = paste0("Baltimore-Columbia-Towson 2016 AMI:\n", dollar(ami.2016)),
           hjust = 1) +
  theme(plot.caption = element_text(hjust = 1, face = "plain"),
        legend.title = element_blank())
```

# Middle neighborhoods have more older homeowners


```{r echo = F}
hmt@data %>%
  filter(hmt.tier != "other") %>%
  group_by(hmt.tier) %>%
  summarise(mean.pct.ho.over65 = percent(mean(Percent_Homeowner_Over_65.2016)),
            med.pct.ho.over65 = percent(median(Percent_Homeowner_Over_65.2016))) %>%
  rename("Mean % Homeowners 65+" = mean.pct.ho.over65,
         "Median % Homeowners 65+" = med.pct.ho.over65) %>%
  kable()
```

```{r echo = F}
hmt@data %>% 
  filter(hmt.tier != "other") %>% 
  ggplot(aes(Percent_Homeowner_Over_65.2016)) +
  geom_freqpoly(aes(color = hmt.tier), stat = "density") +
  theme_iteam_presentations() +
  labs(
    title = "% Homeowners 65+ by HMT Market tier",
    subtitle = "",
    x = "% Homeowners 65+ y.o.",
    y = "Density",
    caption = paste0("tier based on 2017 HMT analysis; ",
                     "% homeowners 65 and over from 2012-2016 ACS data.")
  ) +
  theme(plot.caption = element_text(hjust = 1, face = "plain")) +
  scale_x_continuous(labels = percent)
```


# Top 311 Service Request Types by Tier

```{r echo = F}
sr.norats <- subset(sr, srtype != "SW-Rat Rubout Proactive")

all.sr.bg <- over(sr.norats, hmt)

sr.norats@data <- bind_cols(sr.norats@data, all.sr.bg)

all.sr.bg.counts <- as.data.frame(table(all.sr.bg$bg))

hmt@data <- left_join(hmt@data, all.sr.bg.counts, by = c("bg" = "Var1")) 
  
hmt@data <- hmt@data %>%
  rename(all.sr.count = Freq) %>%
  mutate(sr.ratio = 1000 * all.sr.count / Population.2016)
```


```{r echo = F, include = F}
# quick visual verification

map.points <- sr.norats[sample(1:length(sr.norats), 5000), ]

leaflet() %>%
  setView(lng = -76.6, lat = 39.3, zoom = 11) %>%
  addProviderTiles(providers$Stamen.TonerLite) %>% 
  addCircleMarkers(data = map.points, radius = 1)
  
```

# Total Service Requests per 1,000 Residents

```{r echo = F}
bins <- c(0, 100, 200, 500, 1000, 1500, 2000, Inf)
pal <- colorBin("YlOrRd", domain = hmt$sr.ratio, bins = bins)

leaflet() %>%
  setView(lng = -76.6, lat = 39.3, zoom = 11) %>%
  addProviderTiles(providers$Stamen.TonerLite) %>% 
  addPolygons(data = hmt, 
              fillColor = ~pal(hmt$sr.ratio), 
              color = iteam.colors[2], 
              weight = 1, 
              fillOpacity = 1,
              label = ~as.character(round(hmt$sr.ratio, 0 )))

```

```{r echo = F}
hmt@data %>%
  ggplot(aes(sr.ratio)) +
  geom_histogram() +
  xlim(c(0, 2500)) +
  theme_iteam_google_docs()
```

# Total Service Requests by HMT Tier

```{r echo = F}
sr.by.hmt.tier <- hmt@data %>%
  group_by(hmt.tier) %>%
  summarise(total.pop = sum(Population.2016),
            sr.count = sum(all.sr.count),
            sr.ratio = round(sr.count / total.pop, 2)) %>%
  arrange(desc(sr.ratio))

sr.by.hmt.tier %>% kable()
```

# Top Service Request Type by HMT Tier

```{r echo = F, warning = F}
sr.norats@data %>% 
  filter(!is.na(hmt.tier)) %>%
  count(hmt.tier, srtype) %>% 
  mutate(hmt.tier = as.factor(hmt.tier),
         srtype = as.factor(srtype)) %>%
  left_join(sr.by.hmt.tier %>% select(hmt.tier, total.pop), by = "hmt.tier") %>%
  mutate(sr.ratio = round(1000 * n / total.pop, 1)) %>%
  arrange(hmt.tier, desc(sr.ratio)) %>%
  group_by(hmt.tier) %>%
  filter(row_number() %in% c(1)) %>%
  kable()
```

```{r echo = F, warning = F}
sr.norats@data %>% 
  filter(!is.na(hmt.tier)) %>%
  count(hmt.tier, srtype) %>% 
  mutate(hmt.tier = as.factor(hmt.tier),
         srtype = as.factor(srtype)) %>%
  left_join(sr.by.hmt.tier %>% select(hmt.tier, total.pop), by = "hmt.tier") %>%
  mutate(sr.ratio = round(1000 * n / total.pop, 1)) %>%
  arrange(hmt.tier, desc(sr.ratio)) %>%
  group_by(hmt.tier) %>%
  mutate(rank = row_number()) %>%
  kable()
```

